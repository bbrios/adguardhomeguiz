# å·¥ä½œæµåç§°ï¼šæ›´æ–°è¿‡æ»¤å™¨ï¼ˆUpdate Filtersï¼‰
name: Update Filters

# å·¥ä½œæµè§¦å‘æ¡ä»¶é…ç½®
on:
  # 1. ä»£ç æ¨é€è§¦å‘
  push:
    # å¿½ç•¥æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å˜æ›´ï¼ˆè¿™äº›æ–‡ä»¶æ¨é€ä¸ä¼šè§¦å‘å·¥ä½œæµï¼‰
    paths-ignore:
      - 'README.md'           # å¿½ç•¥ä¸­æ–‡è¯´æ˜æ–‡æ¡£
      - 'README_en.md'        # å¿½ç•¥è‹±æ–‡è¯´æ˜æ–‡æ¡£
      - '.github/**'          # å¿½ç•¥.githubç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
      - '.devcontainer/**'    # å¿½ç•¥å¼€å‘å®¹å™¨é…ç½®ç›®å½•
      - 'LICENSE'             # å¿½ç•¥è®¸å¯è¯æ–‡ä»¶
    # ä»…åœ¨mainåˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘
    branches: [ main ]
  
  # 2. å®šæ—¶è§¦å‘ï¼ˆCronè¡¨è¾¾å¼ï¼‰
  schedule:
    # æ¯23å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰ï¼Œç»“åˆä¸‹æ–¹æ—¶åŒºè®¾ç½®ï¼Œå®é™…ä¸ºåŒ—äº¬æ—¶é—´æ¯8å°æ—¶
    - cron: 0 */23 * * *
  
  # 3. æ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨GitHubç•Œé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµï¼‰
  workflow_dispatch:

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  TZ: Asia/Shanghai

# å®šä¹‰å·¥ä½œæµä»»åŠ¡
jobs:
  # ä»»åŠ¡åç§°ï¼šUpdate_Filtersï¼ˆæ›´æ–°è¿‡æ»¤å™¨ï¼‰
  Update_Filters:
    # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆUbuntuç³»ç»Ÿ
    runs-on: ubuntu-latest
    
    # æƒé™é…ç½®ï¼šå…è®¸å·¥ä½œæµæ“ä½œä»“åº“å†…å®¹å’Œå…¶ä»–Action
    permissions:
      contents: write       # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆå¦‚æäº¤ä»£ç ï¼‰
      actions: write        # å…è®¸æ“ä½œå…¶ä»–Actionï¼ˆå¦‚åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•ï¼‰
      
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - uses: actions/checkout@v3
        # ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œï¼Œè·å–ä»“åº“ä»£ç åˆ°å·¥ä½œæµè¿è¡Œç¯å¢ƒä¸­

      # æ­¥éª¤2ï¼šé…ç½®JDK 17ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'       # æŒ‡å®šJavaç‰ˆæœ¬ä¸º17
          distribution: 'temurin'  # ä½¿ç”¨Eclipse Temurinå‘è¡Œç‰ˆ
          cache: maven             # ç¼“å­˜Mavenä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      # æ­¥éª¤3ï¼šè¿è¡ŒSpring Bootåº”ç”¨ç¨‹åº
      - name: Run Jar
        run:  mvn spring-boot:run  # é€šè¿‡Mavenå‘½ä»¤å¯åŠ¨Spring Bootåº”ç”¨
        # æ¨æµ‹è¯¥åº”ç”¨ä¼šæ‰§è¡Œè¿‡æ»¤å™¨æ›´æ–°æ“ä½œï¼ˆå¦‚ä¸‹è½½ã€å¤„ç†è¿‡æ»¤è§„åˆ™ç­‰ï¼‰

      # æ­¥éª¤4ï¼šè‡ªåŠ¨æäº¤å˜æ›´
      - name: Commit Changes
        id: commit  # å®šä¹‰æ­¥éª¤IDï¼Œç”¨äºåç»­æ­¥éª¤å¼•ç”¨
        uses: stefanzweifel/git-auto-commit-action@v4  # ä½¿ç”¨è‡ªåŠ¨æäº¤Action
        with:
          commit_message: ğŸš€ CI Updated  # æäº¤ä¿¡æ¯å›ºå®šä¸º"ğŸš€ CI Updated"

      # æ­¥éª¤5ï¼šæ¨é€å˜æ›´åˆ°GitHubä»“åº“
      - name: GitHub Push
        # ä»…å½“æ­¥éª¤4æ£€æµ‹åˆ°æœ‰æ–‡ä»¶å˜æ›´æ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤
        if: steps.commit.outputs.changes_detected == 'true'
        uses: ad-m/github-push-action@master  # ä½¿ç”¨æ¨é€Action
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}  # ä½¿ç”¨GitHubæä¾›çš„ä¸´æ—¶ä»¤ç‰Œ
          branch: ${{github.ref}}                  # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆä¸è§¦å‘åˆ†æ”¯ä¸€è‡´ï¼‰

      # æ­¥éª¤6ï¼šåˆ·æ–°CDNç¼“å­˜
      - name: Mirror Refresh
        # ç­‰å¾…10ç§’åï¼Œè¯·æ±‚jsDelivrçš„ç¼“å­˜æ¸…ç†æ¥å£ï¼Œç¡®ä¿æœ€æ–°è§„åˆ™ç”Ÿæ•ˆ
        run: sleep 10 && curl 'https://purge.jsdelivr.net/gh/${{github.repository}}/rule'

      # æ­¥éª¤7ï¼šæ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2  # ä½¿ç”¨åˆ é™¤å·¥ä½œæµè¿è¡Œè®°å½•çš„Action
        with:
          token: ${{secrets.GITHUB_TOKEN}}      # è®¤è¯ä»¤ç‰Œ
          repository: ${{ github.repository }}  # å½“å‰ä»“åº“
          retain_days: 1                        # åªä¿ç•™æœ€è¿‘1å¤©çš„è¿è¡Œè®°å½•
          keep_minimum_runs: 1                  # è‡³å°‘ä¿ç•™1æ¡è¿è¡Œè®°å½•
